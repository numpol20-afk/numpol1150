<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Student Attendance Check</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <!-- Sweet Alert -->
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- Loading Overlay -->
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai');
    * {
      box-sizing: border-box;
      font-family: 'Noto Sans Thai', sans-serif;
    }
    body {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      background: rgb(252, 233, 233);
      background: linear-gradient(0deg, rgba(252, 233, 233, 1) 0%, rgba(224, 244, 241, 1) 26%, rgba(255, 255, 255, 1) 71%);
      -webkit-background-size: cover;
      -moz-background-size: cover;
      -o-background-size: cover;
      flex-direction: column;
    }
    .list {
      background-color: #ffffff;
      padding: 1.8em 1.2em;
      box-shadow: rgba(0, 0, 0, 0.24) 0px 3px 8px;
      border-radius: 0.6em;
    }
    footer {
      margin-top: 10px;
      background-color: #000;
      width: 100%;
      padding: 2px;
      position: fixed;
      bottom: 0;
    }
    footer p,
    footer a {
      text-decoration: none;
      margin: 0;
    }
    footer .fa {
      color: #fff740;
    }
  </style>
</head>
<body>
  <center class="mb-4">
    <img src="https://lh3.googleusercontent.com/d/1ZMI9FTcErAj1N8vh0viy3rAPnxZ7Zsky" class="mt-4" style="width:200px; height:auto; padding-bottom: 10px;">
    <h2>Student Attendance Apps</h2>
    <h5 class="text-center text-danger">สื่อ และนวัตกรรมครูสิทธิชาติ สิทธิ</h5>
  </center>
  <main class="container">
    <div class="container list">
      <div class="d-flex justify-content-center mb-3">
        <button id="check-all-present" class="btn btn-primary me-2">มาทั้งหมด</button>
        <button id="check-all-absent" class="btn btn-secondary">ขาดทั้งหมด</button>
        <button id="check-all-leave" class="btn btn-warning ms-2">ลาทั้งหมด</button>
        <button id="check-all-late" class="btn btn-danger ms-2">สายทั้งหมด</button>
      </div>
      <form id="attendance-form" class="mt-4">

        <!-- เพิ่ม Dropdown เลือกคาบ -->
        <div class="row mb-3">
          <div class="col-12">
            <label for="period-select" class="form-label">เลือกคาบเรียน:</label>
            <select id="period-select" class="form-select" required>
              <option value="">-- เลือกคาบ --</option>
              <option value="คาบโฮมรูม">คาบโฮมรูม</option>
              <option value="คาบ1">คาบ1</option>
              <option value="คาบ2">คาบ2</option>
              <option value="คาบ3">คาบ3</option>
              <option value="คาบ4">คาบ4</option>
              <option value="คาบ5">คาบ5</option>
              <option value="คาบ6">คาบ6</option>
              <option value="คาบ7">คาบ7</option>
              <option value="คาบ8">คาบ8</option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <label class="col-form-label">รายชื่อนักเรียน:</label>
        </div>
        <div id="student-list"></div>
        <center><button type="submit" class="btn btn-primary mt-3">บันทึกข้อมูล</button></center>
      </form>
      <center><button id="send-summary" class="btn btn-success mt-3">แชร์ Flex message</button></center>
    </div>
  </main>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    let attendanceRecords = [];
    const studentListUrl = 'https://opensheet.elk.sh/1Nrp7mvXCZaA-0PbbwCXeStW7WlmpgT0pDVobTA1l7g0/Name';

    window.onload = function() {
      liff.init({ liffId: '2008451449-Pvep2Jx2' })
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            console.log('LIFF initialized');
            fetchStudentList();
            document.getElementById('attendance-form').addEventListener('submit', addAttendanceRecord);
            document.getElementById('send-summary').addEventListener('click', sendSummary);
            document.getElementById('check-all-present').addEventListener('click', () => checkAll('มา'));
            document.getElementById('check-all-absent').addEventListener('click', () => checkAll('ขาด'));
            document.getElementById('check-all-leave').addEventListener('click', () => checkAll('ลา'));
            document.getElementById('check-all-late').addEventListener('click', () => checkAll('สาย'));
          }
        })
        .catch((err) => {
          console.error('Error initializing LIFF: ', err);
          Swal.fire('Error', 'Failed to initialize LIFF: ' + err, 'error');
        });
    };

    function fetchStudentList() {
      fetch(studentListUrl)
        .then(response => response.json())
        .then(data => generateStudentList(data))
        .catch(error => {
          console.error('Error fetching student list: ', error);
          Swal.fire('Error', 'Failed to fetch student list: ' + error, 'error');
        });
    }

    function generateStudentList(students) {
      const studentList = document.getElementById('student-list');
      studentList.innerHTML = ''; // ล้างก่อน
      students.forEach(student => {
        const studentRow = document.createElement('div');
        studentRow.className = 'row mb-3';
        const number = student['เลขที่'];
        const name = student['รายชื่อนักเรียน'];
        studentRow.innerHTML = `
          <div class="col-6">
            <label class="form-label">${number}. ${name}</label>
          </div>
          <div class="col-1">
            <label><input type="radio" name="student${number}" value="มา" required> มา</label>
          </div>
          <div class="col-1">
            <label><input type="radio" name="student${number}" value="ขาด" required> ขาด</label>
          </div>
          <div class="col-1">
            <label><input type="radio" name="student${number}" value="ลา" required> ลา</label>
          </div>
          <div class="col-1">
            <label><input type="radio" name="student${number}" value="สาย" required> สาย</label>
          </div>
        `;
        studentList.appendChild(studentRow);
      });
    }

    function checkAll(status) {
      const radios = document.querySelectorAll(`input[value="${status}"]`);
      radios.forEach(radio => radio.checked = true);
    }

    function addAttendanceRecord(event) {
      event.preventDefault();
      attendanceRecords = [];
      let allSelected = true;

      // ดึงคาบที่เลือก
      const selectedPeriod = document.getElementById('period-select').value;
      if (!selectedPeriod) {
        Swal.fire('กรุณาเลือกคาบ', 'โปรดเลือกคาบเรียนก่อนบันทึก', 'warning');
        return;
      }

      const studentList = document.getElementById('student-list');
      const studentRows = studentList.querySelectorAll('.row');
      studentRows.forEach(row => {
        const label = row.querySelector('.form-label').innerText;
        const name = label.replace(/^\d+\.\s*/, '').trim(); // ลบเลขที่
        const statusInput = row.querySelector('input:checked');
        if (statusInput) {
          attendanceRecords.push({
            name: name,
            status: statusInput.value,
            period: selectedPeriod
          });
        } else {
          allSelected = false;
        }
      });

      if (allSelected) {
        saveToSheet(attendanceRecords);
        document.getElementById('attendance-form').reset();
        document.getElementById('period-select').selectedIndex = 0;
      } else {
        Swal.fire('ผิดพลาด', 'กรุณาเลือกสถานะของนักเรียนทุกคน!', 'error');
      }
    }

    function saveToSheet(records) {
      $.LoadingOverlay("show");
      const url = 'https://script.google.com/macros/s/AKfycbz6FewGN1P6K4B_goPUJoM56f0yfLvZYhZQ2HYvlyi9ALCc6dZ9EYPSdCg7tzGKiQAd/exec'; // เปลี่ยนตาม Web App URL ของคุณ
      $.post(url, JSON.stringify(records), function(data) {
        $.LoadingOverlay("hide");
        if (data.status === 'success') {
          Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อย!', 'success');
        } else {
          Swal.fire('ผิดพลาด', 'บันทึกไม่สำเร็จ!', 'error');
        }
      }).fail(function() {
        $.LoadingOverlay("hide");
        Swal.fire('ผิดพลาด', 'เชื่อมต่อเซิร์ฟเวอร์ไม่ได้!', 'error');
      });
    }

    function formatThaiDate(date) {
      const months = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                      'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
      return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear() + 543}`;
    }

    function sendSummary() {
      if (attendanceRecords.length === 0) {
        Swal.fire('ไม่มีข้อมูล', 'กรุณาบันทึกข้อมูลก่อนแชร์', 'error');
        return;
      }

      const selectedPeriod = document.getElementById('period-select').value || 'ไม่ระบุคาบ';
      const presentCount = attendanceRecords.filter(r => r.status === 'มา').length;
      const absentCount = attendanceRecords.filter(r => r.status === 'ขาด').length;
      const leaveCount = attendanceRecords.filter(r => r.status === 'ลา').length;
      const lateCount = attendanceRecords.filter(r => r.status === 'สาย').length;
      const total = attendanceRecords.length;

      const now = new Date();
      const dateStr = formatThaiDate(now);

      const flexMessage = {
        type: 'flex',
        altText: 'สรุปการเข้าเรียน',
        contents: {
          type: 'bubble',
          size: 'giga',
          header: {
            type: 'box',
            layout: 'vertical',
            contents: [
              { type: 'text', text: 'สรุปการเข้าเรียน ม.3/7', weight: 'bold', size: 'xl', color: '#1DB446' },
              { type: 'text', text: `วันที่ ${dateStr} • ${selectedPeriod}`, size: 'sm', color: '#888888', margin: 'md' }
            ]
          },
          body: {
            type: 'box',
            layout: 'vertical',
            contents: [
              ...attendanceRecords.map(r => ({
                type: 'box',
                layout: 'horizontal',
                contents: [
                  { type: 'text', text: r.name, flex: 4, size: 'md', color: '#555555' },
                  { type: 'text', text: r.status, flex: 2, size: 'md', align: 'end',
                    color: r.status === 'มา' ? '#1DB446' : (r.status === 'ขาด' ? '#FF5555' : (r.status === 'ลา' ? '#FFC107' : '#FF8800'))
                  }
                ]
              })),
              { type: 'separator', margin: 'lg' },
              {
                type: 'box',
                layout: 'vertical',
                margin: 'lg',
                contents: [
                  { type: 'box', layout: 'horizontal', contents: [
                    { type: 'text', text: 'มาเรียน:', flex: 3, color: '#1DB446' },
                    { type: 'text', text: `${presentCount} คน (${((presentCount/total)*100).toFixed(1)}%)`, flex: 2, align: 'end', color: '#1DB446' }
                  ]},
                  { type: 'box', layout: 'horizontal', contents: [
                    { type: 'text', text: 'ขาด:', flex: 3, color: '#FF5555' },
                    { type: 'text', text: `${absentCount} คน (${((absentCount/total)*100).toFixed(1)}%)`, flex: 2, align: 'end', color: '#FF5555' }
                  ]},
                  { type: 'box', layout: 'horizontal', contents: [
                    { type: 'text', text: 'ลา:', flex: 3, color: '#FFC107' },
                    { type: 'text', text: `${leaveCount} คน (${((leaveCount/total)*100).toFixed(1)}%)`, flex: 2, align: 'end', color: '#FFC107' }
                  ]},
                  { type: 'box', layout: 'horizontal', contents: [
                    { type: 'text', text: 'สาย:', flex: 3, color: '#FF8800' },
                    { type: 'text', text: `${lateCount} คน (${((lateCount/total)*100).toFixed(1)}%)`, flex: 2, align: 'end', color: '#FF8800' }
                  ]}
                ]
              }
            ]
          }
        }
      };

      liff.shareTargetPicker([flexMessage])
        .then(res => {
          Swal.fire('สำเร็จ', res ? 'แชร์เรียบร้อย' : 'ยกเลิกการแชร์', res ? 'success' : 'info');
          if (res) liff.closeWindow();
        })
        .catch(err => {
          console.error(err);
          Swal.fire('ผิดพลาด', 'แชร์ไม่สำเร็จ', 'error');
        });
    }
  </script>

  <footer class="text-center text-lg-start bg-light text-muted" style="position: static; left: 0; bottom: 0; width: 100%;">
    <div class="footer-container"></div>
  </footer>
</body>
</html>
