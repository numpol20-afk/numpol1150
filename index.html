<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ประกาศข่าวสารโรงเรียน</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap');
    * { box-sizing: border-box; font-family: 'Noto Sans Thai', sans-serif; }
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px 10px; }
    .container-box { background: #fff; padding: 2rem 1.5rem; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 600px; margin: auto; }
    .form-label { font-weight: 600; color: #333; }
    .btn-primary { background: #5e35b1; border: none; }
    .btn-success { background: #2e7d32; border: none; }
    .btn-success:disabled { background: #aaa; cursor: not-allowed; }
    .preview-img { max-width: 100%; max-height: 200px; border-radius: 0.5rem; margin-top: 10px; display: none; }
    footer { background: #1a1a1a; color: #fff; text-align: center; padding: 12px; position: fixed; bottom: 0; width: 100%; font-size: 0.9rem; }
    .target-badge { font-size: 0.9rem; padding: 0.35rem 0.7rem; border-radius: 2rem; }
  </style>
</head>
<body>
  <div class="text-center mb-4 text-white">
    <h2><i class="fas fa-bullhorn"></i> ประกาศข่าวสาร</h2>
    <h5>โรงเรียนบ้านหนองขุ่น</h5>
  </div>

  <div class="container-box">
    <!-- รหัสผ่านครู -->
    <div class="mb-4" id="password-section">
      <label class="form-label text-danger">รหัสผ่านผู้ดูแล:</label>
      <input type="password" id="admin-password" class="form-control" placeholder="กรอกรหัสผ่าน">
      <button id="login-btn" class="btn btn-danger mt-2 w-100">เข้าสู่ระบบ</button>
    </div>

    <!-- ฟอร์มหลัก -->
    <div id="main-form" style="display: none;">
      <form id="news-form">
        <!-- กลุ่มเป้าหมาย -->
        <div class="mb-4">
          <label class="form-label text-primary">แจ้งถึง:</label>
          <select id="target-select" class="form-select" required>
            <option value="">-- เลือกกลุ่มเป้าหมาย --</option>
            <option value="นักเรียน">นักเรียน</option>
            <option value="ครู">ครู</option>
            <option value="ผู้ปกครอง">ผู้ปกครอง</option>
          </select>
        </div>

        <!-- หัวข้อข่าว -->
        <div class="mb-4">
          <label class="form-label text-success">หัวข้อข่าว:</label>
          <input type="text" id="title-input" class="form-control" placeholder="เช่น ประกาศวันหยุด, กิจกรรมกีฬาสี" required>
        </div>

        <!-- เนื้อหาข่าว -->
        <div class="mb-4">
          <label class="form-label text-info">เนื้อหาข่าวสาร:</label>
          <textarea id="content-input" class="form-control" rows="5" placeholder="พิมพ์รายละเอียด..." required></textarea>
        </div>

        <!-- อัปโหลดรูป -->
        <div class="mb-4">
          <label class="form-label text-warning">รูปภาพประกอบ (ถ้ามี):</label>
          <input type="file" id="image-input" class="form-control" accept="image/*">
          <img id="preview" class="preview-img" alt="ตัวอย่างรูป">
        </div>

        <!-- ปุ่ม -->
        <div class="d-grid gap-2">
          <button type="button" id="save-btn" class="btn btn-primary btn-lg">
            <i class="fas fa-save"></i> บันทึกข้อมูล
          </button>
          <button type="button" id="share-btn" class="btn btn-success btn-lg" disabled>
            <i class="fab fa-line"></i> แชร์ผ่าน LINE
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    const scriptUrl = 'https://script.google.com/macros/s/AKfycbz6FewGN1P6K4B_goPUJoM56f0yfLvZYhZQ2HYvlyi9ALCc6dZ9EYPSdCg7tzGKiQAd/exec'; // เปลี่ยนตาม URL จริง
    const ADMIN_PASSWORD = '123456';
    let newsData = null;
    let imageFile = null;

    window.onload = () => {
      liff.init({ liffId: '2008451449-Pvep2Jx2' })
        .then(() => {
          if (!liff.isLoggedIn()) liff.login();
          else setupLogin();
        })
        .catch(() => Swal.fire('ผิดพลาด', 'ไม่สามารถเริ่มต้น LIFF', 'error'));
    };

    function setupLogin() {
      document.getElementById('login-btn').addEventListener('click', () => {
        const pass = document.getElementById('admin-password').value;
        if (pass === ADMIN_PASSWORD) {
          document.getElementById('password-section').style.display = 'none';
          document.getElementById('main-form').style.display = 'block';
          setupForm();
        } else {
          Swal.fire('รหัสผ่านผิด', 'กรุณากรอกรหัสผ่านให้ถูกต้อง', 'error');
        }
      });
    }

    function setupForm() {
      const preview = document.getElementById('preview');
      document.getElementById('image-input').addEventListener('change', e => {
        imageFile = e.target.files[0];
        if (imageFile) {
          const reader = new FileReader();
          reader.onload = ev => {
            preview.src = ev.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(imageFile);
        } else {
          preview.style.display = 'none';
        }
      });

      document.getElementById('save-btn').addEventListener('click', saveNews);
      document.getElementById('share-btn').addEventListener('click', shareNews);
    }

    function uploadImage() {
      if (!imageFile) return Promise.resolve('');
      
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          const url = `${scriptUrl}?upload=image`;
          fetch(url, {
            method: 'POST',
            body: JSON.stringify({ image: base64, name: imageFile.name })
          })
          .then(r => r.json())
          .then(data => resolve(data.url || ''))
          .catch(reject);
        };
        reader.readAsDataURL(imageFile);
      });
    }

    async function saveNews() {
      const target = document.getElementById('target-select').value;
      const title = document.getElementById('title-input').value.trim();
      const content = document.getElementById('content-input').value.trim();

      if (!target || !title || !content) {
        Swal.fire('กรุณากรอกข้อมูล', 'โปรดระบุ กลุ่มเป้าหมาย หัวข้อ และเนื้อหา', 'warning');
        return;
      }

      $.LoadingOverlay("show");
      try {
        const imageUrl = await uploadImage();
        const payload = { target, title, content, imageUrl };

        $.post(scriptUrl, JSON.stringify(payload), res => {
          $.LoadingOverlay("hide");
          if (res.status === 'success') {
            newsData = payload;
            document.getElementById('share-btn').disabled = false;

            Swal.fire('สำเร็จ!', 'บันทึกข้อมูลเรียบร้อยแล้ว กำลังส่ง Flex Message อัตโนมัติ...', 'success')
              .then(() => {
                // ส่ง Flex Message อัตโนมัติหลังบันทึก
                shareNews();
              });

            // รีเซ็ตฟอร์มหลังส่งเสร็จ
            document.getElementById('news-form').reset();
            document.getElementById('preview').style.display = 'none';
            imageFile = null;
          } else {
            Swal.fire('ผิดพลาด', 'บันทึกไม่สำเร็จ', 'error');
          }
        }).fail(() => {
          $.LoadingOverlay("hide");
          Swal.fire('ผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์', 'error');
        });
      } catch (err) {
        $.LoadingOverlay("hide");
        Swal.fire('ผิดพลาด', 'อัปโหลดรูปภาพล้มเหลว', 'error');
      }
    }

    function shareNews() {
      if (!newsData) {
        Swal.fire('ยังไม่ได้บันทึก', 'กรุณากด "บันทึกข้อมูล" ก่อนแชร์', 'warning');
        return;
      }

      const { target, title, content, imageUrl } = newsData;
      const now = new Date();
      const dateStr = now.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });

      const flexMessage = {
        type: 'flex',
        altText: `ประกาศ: ${title}`,
        contents: {
          type: 'bubble',
          size: 'mega',
          header: {
            type: 'box',
            layout: 'vertical',
            contents: [
              { type: 'text', text: 'ประกาศข่าวสาร', size: 'sm', color: '#aaaaaa' },
              { type: 'text', text: title, size: 'xl', weight: 'bold', color: '#1a1a1a', wrap: true },
              { type: 'text', text: `ถึง: ${target}`, size: 'md', color: '#555555', margin: 'md' }
            ]
          },
          body: {
            type: 'box',
            layout: 'vertical',
            contents: [
              { type: 'separator', margin: 'lg' },
              { type: 'text', text: content, size: 'md', color: '#333333', margin: 'lg', wrap: true },
              ...(imageUrl ? [
                { type: 'image', url: imageUrl, size: 'full', aspectRatio: '3:2', aspectMode: 'cover', margin: 'lg' }
              ] : []),
              { type: 'separator', margin: 'lg' },
              { type: 'text', text: `วันที่: ${dateStr}`, size: 'sm', color: '#888888', align: 'end', margin: 'md' }
            ]
          },
          footer: {
            type: 'box',
            layout: 'vertical',
            contents: [
              { type: 'text', text: 'โรงเรียนบ้านหนองขุ่น', size: 'sm', color: '#888888', align: 'center' }
            ]
          }
        }
      };

      liff.shareTargetPicker([flexMessage])
        .then(res => {
          Swal.fire(res ? 'สำเร็จ' : 'ยกเลิก', res ? 'แชร์เรียบร้อย' : 'ยกเลิกการแชร์', res ? 'success' : 'info');
          if (res) liff.closeWindow();
        })
        .catch(() => Swal.fire('ผิดพลาด', 'ไม่สามารถแชร์ได้', 'error'));
    }
  </script>
  <footer>
    <p>พัฒนาโดย ครูนำพล สาสิงห์ | @NumpolSasing</p>
  </footer>
</body>
</html>
